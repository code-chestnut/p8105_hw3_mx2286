---
title: "p8105_hw3_mx2286"
author: "Mingye"
date: "2024-10-15"
output: github_document
---

# Problem 1
```{r setup, include=FALSE}
library(p8105.datasets)
library(dplyr)
library(janitor)
library(lubridate)
library(tidyverse)
library(ggplot2)
library(patchwork)
```

Import and clean Dataset

# Problem 1

**load data**
```{r}
data("ny_noaa")
```

**Overall**
```{r}
str(ny_noaa)
colMeans(is.na(ny_noaa)) * 100
```

The dataset consists of 2,595,176 rows and 7 columns. Each row represents a daily weather observation, and the key variables include:

`id`: A character variable identifying the weather station.
`date`: A date variable representing the date of the observation.
`prcp`: An integer variable indicating precipitation.
`snow`: An integer variable for snowfall measurements.
`snwd`: An integer variable for snow depth.
`tmax`: A character variable representing the maximum temperature for the day.
`tmin`: A character variable representing the minimum temperature.

Several key variables contain many NA values: 

`prcp`: 5.62% missing value.
`snow`: 14.69% missing value.
`snwd`: 22.80% missing value.
`tmax`: 43.71% missing value.
`tmin`: 43.71% missing value.

**data cleaning**
```{r}
ny_noaa = ny_noaa |> 
  janitor::clean_names() |> 
  mutate(year = as.numeric(format(date, "%Y")),
         month = as.numeric(format(date, "%m")),
         day = as.numeric(format(date, "%d")),
         tmax = as.integer(tmax) / 10,
         tmin = as.integer(tmin) / 10,
         prcp = prcp / 10)

ny_noaa |> 
  group_by(snow) |> 
  summarise(count = n()) |> 
  arrange(desc(count)) |> 
  head(n=5)
```

The most commonly observed value for snowfall is 0. 

**plot 1**
```{r}
ny_noaa |> 
  filter(month == '1' | month == '7') |> 
  group_by(year, month) |> 
  summarise(avg_tmax = mean(tmax, na.rm = TRUE), .groups = "drop") |> 
  ungroup() |> 
  ggplot(aes(x = year, y = avg_tmax)) +
  geom_point() +
  facet_wrap(~month) +
  labs(
    title = "Average Max Temp in January and July Across Years",
    x = "Year", y = "Average Max °C"
  ) 
```

Temperatures in January show a gradual increase around 0°C over time. In July, temperatures consistently range between 25-30°C across all years, without any clear trend. In January, a few data points slightly above or below 0°C could be considered outliers.

**plot 2**
```{r}
tmax_tmin = ny_noaa |> 
  filter(!is.na(tmax) & !is.na(tmin)) |> 
  ggplot(aes(x=tmin, y=tmax)) +
  geom_hex(bins = 30) +
  labs(title = "Hexbin Plot of Tmax vs Tmin", x = "Tmin (°C)", y = "Tmax (°C)")

snow_dist = ny_noaa |> 
  filter(snow > 0 & snow < 100) |> 
  ggplot(aes(x=year, y=snow)) +
  geom_violin() +
  labs(title = "Snowfall Distribution (0 < Snowfall < 100) by Year", x = "Year", y = "Snowfall (mm)")

# Combine the two plots using patchwork
tmax_tmin + snow_dist
```
# Problem 2

**data cleaning**
```{r}
accel = read.csv("nhanes_accel.csv") |> 
  janitor::clean_names()

covar = read.csv("nhanes_covar.csv", skip = 4) |> 
  janitor::clean_names() |> 
  filter(age >= 21, !is.na(sex), !is.na(age), !is.na(bmi), !is.na(education)) |> 
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    education = factor(education, 
                       levels = c(1, 2, 3), 
                       labels = c("Less than high school", 
                                  "High school equivalent", 
                                  "More than high school"))
  )

mims = inner_join(accel, covar, by = "seqn")
```

**table**
```{r}
mims |> 
  group_by(sex, education) |> 
 summarize(count = n(), .groups = "drop") |> 
  pivot_wider(
    names_from = sex,
    values_from = count,
    values_fill = list(count = 0)  # fill missing combinations with 0
  ) |> 
  knitr::kable()

mims |>
  group_by(sex, education) |> 
  ggplot(aes(x = sex, y = age, color = education)) +
  geom_boxplot() +
  labs(
    title = "Age distributions in each education category",
    x = "Sex", y = "Age"
  )

```
The "Less than high school" group has nearly equal representation of men and women. In the "High school equivalent" category, men notably outnumber women. In the "More than high school" group, the gender balance is relatively even, with a slight majority of women. Additionally, this group exhibits the widest range in age.

**Total Activity vs. Age by Sex and Education Level**
```{r}
mims |> 
  rowwise() |>
  mutate(activity = sum(c_across(starts_with("min")), na.rm = TRUE)) |> 
  ungroup() |> 
  group_by(sex, education) |> 
  ggplot(aes(x = age, y = activity, color = sex)) +
  geom_point(alpha = 0.6, size = 2) +  
  geom_smooth(method = "loess") + 
  facet_wrap(~education) +
  labs(
    title = "Total Activity vs. Age by Sex and Education Level",
    x = "Age", y = "Total Daily Activity"
  ) 
```
Higher education levels are linked to more stable activity patterns throughout life, while lower education levels display greater variability and a sharper decline in activity, particularly among women. Gender differences are most evident in the lower education groups, where women tend to have higher activity levels in early adulthood but experience a more pronounced decline with age.

**24-Hour Activity Time Courses by Education Level and Sex**
```{r}
mims |> 
  pivot_longer(cols = starts_with("min"), 
               names_to = "minute", 
               names_prefix = "min", 
               values_to = "activity") |> 
  mutate(minute = as.numeric(minute))  |> 
  group_by(minute, sex, education) |> 
  summarize(mean_activity = mean(activity, na.rm = TRUE), .groups = "drop") |> 
  ggplot(aes(x = minute, y = mean_activity, color = sex)) +
  geom_point(alpha = 0.2, size = 1.5) +  
  geom_smooth(size = 1.2) +
  facet_wrap(~education, nrow = 3) +
  scale_x_continuous(breaks = seq(0, 1440, by = 120), 
                     labels = function(x) sprintf("%02d:00", x / 60)) +
  labs(title = "24-Hour Activity Time Courses by Education Level and Sex",
       x = "Time of Day (Hours)",  # Clarified label
       y = "Mean Activity Level",
       color = "Sex")
```
While there are minor differences in the timing and intensity of activity peaks, the overall daily activity pattern is consistent across all education levels. Activity levels are lower in the early morning and late night, with noticeable peaks in the late morning and early afternoon.

Women, particularly in the higher education groups, exhibit higher activity levels in the morning. Men generally show slightly elevated activity in the afternoon and evening, especially in the "Less than high school" group.

Individuals with more education maintain higher and more consistent activity levels throughout the day, while those with less education tend to have lower overall activity and experience a decline in activity earlier in the day.

# Problem 3

**Data Cleaning**
