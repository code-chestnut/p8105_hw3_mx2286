---
title: "p8105_hw3_mx2286"
author: "Mingye"
date: "2024-10-15"
output: github_document
---

```{r setup, include=FALSE}
library(p8105.datasets)
library(dplyr)
library(janitor)
library(lubridate)
library(tidyverse)
library(ggplot2)
library(patchwork)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1

**load data**

```{r}
data("ny_noaa")
```

**Overall**

```{r}
str(ny_noaa)
colMeans(is.na(ny_noaa)) * 100
```

This dataset contains `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. Variables include weather station id, date of observation, (tenths of mm), snowfall (mm), snow depth (mm), and min and max temperature (tenths of degrees C).

Several key variables contain many NA values:

`prcp`: 5.61958% missing value. `snow`: 14.68960% missing value. `snwd`: 22.80331% missing value. `tmax`: 43.71025% missing value. `tmin`: 43.71264% missing value.

**data cleaning**

```{r}
ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n))

ny_noaa = 
  ny_noaa %>% 
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>% 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))
```

The most commonly observed value for snowfall is 0.

**plot 1**

```{r}
ny_noaa %>% 
  group_by(id, year, month) %>% 
  filter(month %in% c(1, 7)) %>% 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) %>% 
  ggplot(aes(x = year, y = mean_tmax, group = id)) + geom_point() + geom_path() +
  facet_grid(~month) +
  labs(title = "Mean monthly temperature for each station across years for January and July")
```

Temperatures in January show a gradual increase around 0°C over time. In July, temperatures consistently range between 25-30°C across all years, without any clear trend. In January, a few data points slightly above or below 0°C could be considered outliers.

**plot 2**

```{r}
hex = 
  ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

ridge = 
  ny_noaa %>% 
  filter(snow < 100, snow > 0) %>%
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges()

hex + ridge
```

# Problem 2

**data cleaning**

```{r}
accel = read.csv("nhanes_accel.csv") |> 
  janitor::clean_names()

covar = read.csv("nhanes_covar.csv", skip = 4) |> 
  janitor::clean_names() |> 
  filter(age >= 21, !is.na(sex), !is.na(age), !is.na(bmi), !is.na(education)) |> 
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    education = factor(education, 
                       levels = c(1, 2, 3), 
                       labels = c("Less than high school", 
                                  "High school equivalent", 
                                  "More than high school"))
  )

mims = inner_join(accel, covar, by = "seqn")
```

*table*

```{r}
mims |> 
  group_by(sex, education) |> 
 summarize(count = n(), .groups = "drop") |> 
  pivot_wider(
    names_from = sex,
    values_from = count,
    values_fill = list(count = 0)  # fill missing combinations with 0
  ) |> 
  knitr::kable()

mims |>
  group_by(sex, education) |> 
  ggplot(aes(x = sex, y = age, color = education)) +
  geom_boxplot() +
  labs(
    title = "Age distributions in each education category",
    x = "Sex", y = "Age"
  )

```

The "Less than high school" group has nearly equal representation of men and women. In the "High school equivalent" category, men notably outnumber women. In the "More than high school" group, the gender balance is relatively even, with a slight majority of women. Additionally, this group exhibits the widest range in age.

*Total Activity vs. Age by Sex and Education Level*

```{r}
mims |> 
  rowwise() |>
  mutate(activity = sum(c_across(starts_with("min")), na.rm = TRUE)) |> 
  ungroup() |> 
  group_by(sex, education) |> 
  ggplot(aes(x = age, y = activity, color = sex)) +
  geom_point(alpha = 0.6, size = 2) +  
  geom_smooth(method = "loess") + 
  facet_wrap(~education) +
  labs(
    title = "Total Activity vs. Age by Sex and Education Level",
    x = "Age", y = "Total Daily Activity"
  ) 
```

Higher education levels are linked to more stable activity patterns throughout life, while lower education levels display greater variability and a sharper decline in activity, particularly among women. Gender differences are most evident in the lower education groups, where women tend to have higher activity levels in early adulthood but experience a more pronounced decline with age.

*24-Hour Activity Time Courses by Education Level and Sex*

```{r}
mims |> 
  pivot_longer(cols = starts_with("min"), 
               names_to = "minute", 
               names_prefix = "min", 
               values_to = "activity") |> 
  mutate(minute = as.numeric(minute))  |> 
  group_by(minute, sex, education) |> 
  summarize(mean_activity = mean(activity, na.rm = TRUE), .groups = "drop") |> 
  ggplot(aes(x = minute, y = mean_activity, color = sex)) +
  geom_point(alpha = 0.2, size = 1.5) +  
  geom_smooth(size = 1.2) +
  facet_wrap(~education, nrow = 3) +
  scale_x_continuous(breaks = seq(0, 1440, by = 120), 
                     labels = function(x) sprintf("%02d:00", x / 60)) +
  labs(title = "24-Hour Activity Time Courses by Education Level and Sex",
       x = "Time of Day (Hours)",  # Clarified label
       y = "Mean Activity Level",
       color = "Sex")
```

While there are minor differences in the timing and intensity of activity peaks, the overall daily activity pattern is consistent across all education levels. Activity levels are lower in the early morning and late night, with noticeable peaks in the late morning and early afternoon.

Women, particularly in the higher education groups, exhibit higher activity levels in the morning. Men generally show slightly elevated activity in the afternoon and evening, especially in the "Less than high school" group.

Individuals with more education maintain higher and more consistent activity levels throughout the day, while those with less education tend to have lower overall activity and experience a decline in activity earlier in the day.

# Problem 3

**Data Cleaning**

```{r}
bike20Jan <- read.csv("Jan 2020 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(year = 2020, month = "Jan")
bike20July <- read.csv("July 2020 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(year = 2020, month = "July")
bike24Jan <- read.csv("Jan 2024 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(year = 2024, month = "Jan")
bike24July <- read.csv("July 2024 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(year = 2024, month = "July")

citibike = bind_rows(bike20Jan, bike20July, bike24Jan, bike24July) |> 
  mutate(
    weekdays = factor(weekdays, 
                      levels =c("Monday", "Tuesday", "Wednesday", "Thursday", 
                                "Friday", "Saturday", "Sunday")),
    month = factor(month),
    year = factor(year),
   rideable_type = factor(rideable_type)
  )

str(citibike)
```

The final dataset consists of 99,485 observations and 9 variables, including `ride_id`, `rideable_type`, `weekdays`, `duration`, `start_station_name`, `end_station_name`, `member_casual`, `year`, `month`.

*table 1*

```{r}
citibike |> 
  group_by(year, month, member_casual) |>
  summarize(number = n(),.groups = "drop") |> 
  pivot_wider(
    names_from = member_casual,
    values_from = number) |> 
  knitr::kable()
```

From 2020 to 2024, there has been a notable increase in total rides, with a significant surge observed in July 2024. This trend likely reflects growing popularity, possibly driven by expanded infrastructure, improved accessibility, or rising public interest in bike-sharing services. *table 2*

```{r}
citibike |> 
  filter(year == 2024, month == "July") |>  
  group_by(start_station_name) |>  
  summarize(total_ride = n()) |>  
  arrange(desc(total_ride)) |>  
  slice_max(total_ride, n = 5) |>
  knitr::kable(caption = "Top 5 Most Popular Starting Stations for July 2024")
```

*Median Ride Duration by Day of Week, Month, and Year*

```{r}
citibike |> 
  group_by(year, month, weekdays) |>  
  summarize(median_duration = median(duration)) |> 
  ggplot(aes(x = weekdays, y = median_duration, color = factor(year))) +
  geom_point(aes(group = year)) +
  geom_line(aes(group = year)) +  
  facet_wrap(~ month + year, ncol = 2, nrow = 2) +  
  labs(title = "Median Ride Duration by Day of Week, Month, and Year",
       x = "Day of the Week", 
       y = "Median Ride Duration (minutes)", 
       color = "Year")
```

Ride durations in the colder month of January are noticeably shorter compared to those in July, likely due to harsher weather conditions, which make biking less comfortable or practical. In contrast, the warmer month of July sees significantly longer rides, especially on weekends. This trend is evident in both 2020 and 2024.

The increase in weekend ride durations during July suggests that many riders are taking advantage of the favorable summer weather for recreational activities or leisurely outings. Weekends may also provide more free time for longer trips, contributing to the spike in usage. Additionally, the data indicates that seasonal factors, such as holidays or vacations in July, could further influence the increased duration of rides during this period.

*Impact of Month, Membership Status, and Bike Type 2024*

```{r}
citibike |> 
  filter(year == 2024) |> 
  ggplot(aes(x = month, y = duration, color = rideable_type)) +
  geom_boxplot(outlier.alpha = 0.7) +  
  facet_wrap(~ member_casual) +
  labs(title = "Impact of Month, Membership Status, and Bike Type 2024",
       x = "Month",
       y = "Ride Duration (minutes)",
       color = "Bike Type") +
  theme_minimal()  # Optional: Cleaner theme for readability

```

Electric bikes are frequently chosen for longer rides, with casual riders showing a clear preference for them during extended trips. This may be due to the additional ease and speed that electric bikes provide, making them an attractive option for non-members who may be riding for leisure or covering longer distances.

In contrast, members tend to exhibit more consistent ride durations regardless of bike type. This suggests that members, who may use the service more regularly for commuting or errands, prioritize convenience and efficiency over ride length, leading to more uniform usage patterns across both electric and traditional bikes.
